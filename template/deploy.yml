parameters:
  - name: Environment
    type: string
  - name: adfName
    type: string
  - name: resourceGroup
    type: string
  - name: AzureServiceConnection
    type: string
  - name: subscriptionID
    type: string


jobs:
- deployment: DeployADF
  displayName: Deploy ADF to ${{ parameters.Environment }}
  environment: ${{ parameters.Environment }}

  strategy:
    runOnce:
      deploy:
        steps:

        # ---------------------------------------
        # 1) Download Artifact
        # ---------------------------------------
        - task: DownloadPipelineArtifact@2
          displayName: Download ADF Artifact
          inputs:
            source: current
            artifact: adf_publish
            path: '$(Pipeline.Workspace)/adf_publish'


        # ---------------------------------------
        # 2) Debug â€” List Files
        # ---------------------------------------
        - powershell: |
            Write-Host "ADF artifact contents:"
            Get-ChildItem -Recurse "$(Pipeline.Workspace)/adf_publish"
          displayName: List Artifact Files


        # ---------------------------------------
        # 3) Check Script Exists
        # ---------------------------------------
        - powershell: |
            $path = "$(Pipeline.Workspace)/adf_publish/script/PrePostDeploymentScript.ps1"
            if (Test-Path $path) {
              Write-Host "##vso[task.setvariable variable=scriptExists]true"
            } else {
              Write-Host "##vso[task.setvariable variable=scriptExists]false"
            }
          displayName: Verify Script Exists


        # ---------------------------------------
        # 4) Stop Triggers
        # ---------------------------------------
        - task: AzurePowerShell@5
          displayName: Stop ADF Triggers
          condition: and(succeeded(), eq(variables.scriptExists, 'true'))
          inputs:
            azureSubscription: ${{ parameters.AzureServiceConnection }}
            ScriptType: FilePath
            ScriptPath: '$(Pipeline.Workspace)/adf_publish/script/PrePostDeploymentScript.ps1'
            ScriptArguments: >
              -ResourceGroupName ${{ parameters.resourceGroup }}
              -DataFactoryName ${{ parameters.adfName }}
              -Action Stop
            azurePowerShellVersion: LatestVersion


        # ---------------------------------------
        # 5) Deploy ARM
        # ---------------------------------------
        - task: AzureResourceManagerTemplateDeployment@3
          displayName: Deploy ADF ARM Template
          inputs:
            deploymentScope: Resource Group
            azureResourceManagerConnection: ${{ parameters.AzureServiceConnection }}
            subscriptionId: ${{ parameters.subscriptionID }}
            action: Create Or Update Resource Group
            resourceGroupName: ${{ parameters.resourceGroup }}
            location: Central India
            templateLocation: Linked artifact
            csmFile: '$(Pipeline.Workspace)/adf_publish/ARMTemplateForFactory.json'
            csmParametersFile: '$(Pipeline.Workspace)/adf_publish/ARMTemplateParametersForFactory.json'
            overrideParameters: |
              -factoryName ${{ parameters.adfName }}
            deploymentMode: Incremental


        # ---------------------------------------
        # 6) Start Triggers
        # ---------------------------------------
        - task: AzurePowerShell@5
          displayName: Start ADF Triggers
          condition: and(succeeded(), eq(variables.scriptExists, 'true'))
          inputs:
            azureSubscription: ${{ parameters.AzureServiceConnection }}
            ScriptType: FilePath
            ScriptPath: '$(Pipeline.Workspace)/adf_publish/script/PrePostDeploymentScript.ps1'
            ScriptArguments: >
              -ResourceGroupName ${{ parameters.resourceGroup }}
              -DataFactoryName ${{ parameters.adfName }}
              -Action Start
            azurePowerShellVersion: LatestVersion

# parameters:
#   - name: Environment
#     type: string
#   - name: adfName
#     type: string
#   - name: resourceGroup
#     type: string
#   - name: AzureServiceConnection
#     type: string
#   - name: subscriptionID
#     type: string

# jobs:
# - deployment: DeployADF
#   displayName: Deploy ADF to ${{ parameters.Environment }}
#   environment: ${{ parameters.Environment }}
#   strategy:
#     runOnce:
#       deploy:
#         steps:

#         # -----------------------------------------------
#         # 1) Download Build Artifacts
#         # -----------------------------------------------
#         - task: DownloadPipelineArtifact@2
#           displayName: 'Download build artifacts'
#           inputs:
#             source: current
#             path: 'adf_publish'

#         # -----------------------------------------------
#         # 2) List Artifact Files (Debug)
#         # -----------------------------------------------
#         - powershell: |
#             Write-Host "Listing drop contents:"
#             Get-ChildItem -Recurse -File "$(Pipeline.Workspace)/drop" | Select-Object FullName
#           displayName: 'List downloaded files'

      
#         # -----------------------------------------------
#         # 3) DEBUG â€” Search for Script (ADD THIS HERE)
#         # -----------------------------------------------
#         - powershell: |
#             Write-Host "ðŸ” DEBUG â€” Searching for PrePostDeploymentScript.ps1 inside drop folder"
#             Get-ChildItem -Recurse "$(Pipeline.Workspace)/drop" |
#               Where-Object { $_.Name -eq "PrePostDeploymentScript.ps1" } |
#               Select-Object FullName
#           displayName: "DEBUG Search Script"
    

#         # -----------------------------------------------
#         # 3) Check if Script Exists
#         # -----------------------------------------------
#         - powershell: |
#             $path = "$(Pipeline.Workspace)/drop/script/PrePostDeploymentScript.ps1"
#             Write-Host "Checking: $path"
#             if (Test-Path $path) {
#               Write-Host "##vso[task.setvariable variable=scriptExists]true"
#               Write-Host "Script found."
#             } else {
#               Write-Host "##vso[task.setvariable variable=scriptExists]false"
#               Write-Host "Script NOT found!"
#             }
#           displayName: 'Verify script exists'

#         # -----------------------------------------------
#         # 4) Stop Triggers (Pre-deploy)
#         # -----------------------------------------------
#         - task: AzurePowerShell@5
#           displayName: 'Pre-deploy: Stop ADF triggers'
#           inputs:
#             azureSubscription: ${{ parameters.AzureServiceConnection }}
#             ScriptType: 'FilePath'
#             ScriptPath: '$(Pipeline.Workspace)/drop/script/PrePostDeploymentScript.ps1'
#             ScriptArguments: >
#               -ResourceGroupName ${{ parameters.resourceGroup }}
#               -DataFactoryName ${{ parameters.adfName }}
#               -Action Stop
#             azurePowerShellVersion: 'LatestVersion'
#           condition: and(succeeded(), eq(variables.scriptExists, 'true'))

#         # -----------------------------------------------
#         # 5) Deploy ARM Template
#         # -----------------------------------------------
#         - task: AzureResourceManagerTemplateDeployment@3
#           displayName: 'Deploy ADF ARM Template'
#           inputs:
#             deploymentScope: 'Resource Group'
#             azureResourceManagerConnection: ${{ parameters.AzureServiceConnection }}
#             subscriptionId: ${{ parameters.subscriptionID }}
#             action: 'Create Or Update Resource Group'
#             resourceGroupName: ${{ parameters.resourceGroup }} 
#             location: 'Central India'
#             templateLocation: 'Linked artifact'
#             csmFile: '$(Pipeline.Workspace)/drop/ARMTemplateForFactory.json'
#             csmParametersFile: '$(Pipeline.Workspace)/drop/ARMTemplateParametersForFactory.json'
#             overrideParameters: |
#               -factoryName ${{ parameters.adfName }}
#             deploymentMode: 'Incremental'

#         # -----------------------------------------------
#         # 6) Start Triggers (Post-deploy)
#         # -----------------------------------------------
#         - task: AzurePowerShell@5
#           displayName: 'Post-deploy: Start ADF triggers'
#           inputs:
#             azureSubscription: ${{ parameters.AzureServiceConnection }}
#             ScriptType: 'FilePath'
#             ScriptPath: '$(Pipeline.Workspace)/drop/script/PrePostDeploymentScript.ps1'
#             ScriptArguments: >
#               -ResourceGroupName ${{ parameters.resourceGroup }}
#               -DataFactoryName ${{ parameters.adfName }}
#               -Action Start
#             azurePowerShellVersion: 'LatestVersion'
#           condition: and(succeeded(), eq(variables.scriptExists, 'true'))

# parameters:
#   - name: Environment
#     type: string
#   - name: adfName
#     type: string
#   - name: resourceGroup
#     type: string
#   - name: AzureServiceConnection
#     type: string
#   - name: subscriptionID
#     type:         # -AzureBlobStorage1_connectionString "$(blobSourceConnString)"
              # -AzureBlobStorage2_connectionString "$(blobDestConnString)"
# jobs:
# - deployment: DeployADF
#   displayName: Deploy ADF to ${{ parameters.Environment }}
#   environment: ${{ parameters.Environment }}
#   strategy:
#     runOnce:
#       deploy:
#         steps:
#         - task: DownloadPipelineArtifact@2
#           displayName: 'Download build artifacts'
#           inputs:
#             source: current
#             path: '$(Pipeline.Workspace)'

#         - powershell: |
#             Write-Host "System.DefaultWorkingDirectory: $(System.DefaultWorkingDirectory)"
#             Write-Host "Listing 'drop' contents..."
#             Get-ChildItem -Recurse -File "$(Pipeline.Workspace)/drop" | Select-Object FullName
#           displayName: 'List downloaded files'

#         # Pre-deploy: Stop triggers
#         - task: AzurePowerShell@5
#           displayName: 'Pre-deploy: Stop ADF triggers'
#           inputs:
#             azureSubscription: ${{ parameters.AzureServiceConnection }}
#             ScriptType: 'FilePath'
#             ScriptPath: '$(Pipeline.Workspace)/drop/scripts/PrePostDeploymentScript.ps1'
#             ScriptArguments: >
#               -ResourceGroupName ${{ parameters.resourceGroup }}
#               -DataFactoryName ${{ parameters.adfName }}
#               -Action Stop
#             azurePowerShellVersion: 'LatestVersion'
#           condition: and(succeeded(), exists('$(Pipeline.Workspace)/drop/scripts/PrePostDeploymentScript.ps1'))

#         # Deploy ARM
#         - task: AzureResourceManagerTemplateDeployment@3
#           displayName: 'Deploy ADF ARM Template'
#           inputs:
#             deploymentScope: 'Resource Group'
#             azureResourceManagerConnection: ${{ parameters.AzureServiceConnection }}
#             subscriptionId: ${{ parameters.subscriptionID }}
#             action: 'Create Or Update Resource Group'
#             resourceGroupName: ${{ parameters.resourceGroup }}
#             location: 'Central India'
#             templateLocation: 'Linked artifact'
#             csmFile: '$(Pipeline.Workspace)/drop/ARMTemplateForFactory.json'
#             csmParametersFile: '$(Pipeline.Workspace)/drop/ARMTemplateParametersForFactory.json'
#             overrideParameters: |
#               -factoryName ${{ parameters.adfName }}
#             deploymentMode: 'Incremental'

#         # Post-deploy: Start triggers
#         - task: AzurePowerShell@5
#           displayName: 'Post-deploy: Start ADF triggers'
#           inputs:
#             azureSubscription: ${{ parameters.AzureServiceConnection }}
#             ScriptType: 'FilePath'
#             ScriptPath: '$(Pipeline.Workspace)/drop/scripts/PrePostDeploymentScript.ps1'
#             ScriptArguments: >
#               -ResourceGroupName ${{ parameters.resourceGroup }}
#               -DataFactoryName ${{ parameters.adfName }}
#               -Action Start
#             azurePowerShellVersion: 'LatestVersion'
#           condition: and(succeeded(), exists('$(Pipeline.Workspace)/drop/scripts/PrePostDeploymentScript.ps1'))
# parameters:
#   - name: Environment
#     type: string
#   - name: adfName
#     type: string
#   - name: resourceGroup
#     type: string
#   - name: AzureServiceConnection
#     type: string
#   - name: subscriptionID
#     type: string

    
# jobs:
# - deployment: DeployADF
#   displayName: Deploy ADF to ${{ parameters.Environment }}
#   environment: ${{ parameters.Environment }}
#   strategy:
#     runOnce:
#       deploy:
#         steps:
#         - task: DownloadPipelineArtifact@2 #downloading artifacts created in build stage
#           inputs:
#             source: 'current'
#             path: '$(Pipeline.Workspace)'
#         # - powershell: |
#         #     Write-Host "System.DefaultWorkingDirectory: $(System.DefaultWorkingDirectory)"
#         #     Get-ChildItem -Recurse -File $(System.DefaultWorkingDirectory)\drop | Select-Object FullName
#         #   displayName: 'List downloaded files'

#           # 2) Diagnostics: list downloaded files
#         - powershell: |
#             Write-Host "System.DefaultWorkingDirectory: $(System.DefaultWorkingDirectory)"
#             Write-Host "Listing 'drop' contents..."
#             Get-ChildItem -Recurse -File "$(System.DefaultWorkingDirectory)\drop" | Select-Object FullName
#           displayName: 'List downloaded files'
#         - task: AzureResourceManagerTemplateDeployment@3
#           displayName: ' Deploy ADF ARM Template'
#           inputs:
#             deploymentScope: 'Resource Group'
#             azureResourceManagerConnection: ${{ parameters.AzureServiceConnection }}
#             devSubscriptionId: 'e3d41855-059e-4340-b9ba-28d873e8605b'
#             action: 'Create Or Update Resource Group'
#             resourceGroupName: ${{ parameters.resourceGroup }}
#             location: 'Central India'
#             templateLocation: 'Linked artifact'
#             csmFile: '$(Pipeline.Workspace)/drop/ARMTemplateForFactory.json'
#             csmParametersFile: '$(Pipeline.Workspace)/drop/ARMTemplateParametersForFactory.json'
#             overrideParameters: |
#                 -factoryName ${{ parameters.adfName }}
#             deploymentMode: 'Incremental'   
            
#         # - task: AzureResourceManagerTemplateDeployment@3
#         #   displayName: 'Deploy ARM Template - DEV'
#         #   inputs:
#         #     deploymentScope: 'Resource Group'
#         #     azureResourceManagerConnection: '$(azureServiceConnection)'
#         #     subscriptionId: '$(devSubscriptionId)'
#         #     action: 'Create Or Update Resource Group'
#         #     resourceGroupName: '$(devResourceGroup)'
#         #     location: 'East US'   # CHANGE_ME if needed
#         #     templateLocation: 'Linked artifact'
#         #     csmFile: '$(Pipeline.Workspace)/$(artifactName)/$(armOutputFolder)/ARMTemplateForFactory.json'
#         #     csmParametersFile: '$(Pipeline.Workspace)/$(artifactName)/arm-parameters/dev.parameters.json'
#         #     deploymentMode: 'Incremental'
#         #     deploymentName: 'adf-dev-$(Build.BuildId)' 
            
         

# parameters:
#   - name: Environment
#     type: string
#   - name: adfName
#     type: string
#   - name: resourceGroup
#     type: string
#   - name: AzureServiceConnection
#     type: string
#   - name: subscriptionID
#     type: string

    
# jobs:
# - deployment: DeployADF
#   displayName: Deploy ADF to ${{ parameters.Environment }}
#   environment: ${{ parameters.Environment }}
#   strategy:
#     runOnce:
#       deploy:
#         steps:
#         - task: DownloadPipelineArtifact@2 #downloading artifacts created in build stage
#           inputs:
#             source: 'current'
#             path: '$(Pipeline.Workspace)'
#         # - powershell: |
#         #     Write-Host "System.DefaultWorkingDirectory: $(System.DefaultWorkingDirectory)"
#         #     Get-ChildItem -Recurse -File $(System.DefaultWorkingDirectory)\drop | Select-Object FullName
#         #   displayName: 'List downloaded files'

#           # 2) Diagnostics: list downloaded files
#         - powershell: |
#             Write-Host "System.DefaultWorkingDirectory: $(System.DefaultWorkingDirectory)"
#             Write-Host "Listing 'drop' contents..."
#             Get-ChildItem -Recurse -File "$(System.DefaultWorkingDirectory)\drop" | Select-Object FullName
#           displayName: 'List downloaded files'
#         - task: AzureResourceManagerTemplateDeployment@3
#           displayName: ' Deploy ADF ARM Template'
#           inputs:
#             deploymentScope: 'Resource Group'
#             azureResourceManagerConnection: ${{ parameters.AzureServiceConnection }}
#             devSubscriptionId: 'e3d41855-059e-4340-b9ba-28d873e8605b'
#             action: 'Create Or Update Resource Group'
#             resourceGroupName: ${{ parameters.resourceGroup }}
#             location: 'Central India'
#             templateLocation: 'Linked artifact'
#             csmFile: '$(Pipeline.Workspace)/drop/ARMTemplateForFactory.json'
#             csmParametersFile: '$(Pipeline.Workspace)/drop/ARMTemplateParametersForFactory.json'
#             overrideParameters: |
#                 -factoryName ${{ parameters.adfName }}
#             deploymentMode: 'Incremental'   
            
#         # - task: AzureResourceManagerTemplateDeployment@3
#         #   displayName: 'Deploy ARM Template - DEV'
#         #   inputs:
#         #     deploymentScope: 'Resource Group'
#         #     azureResourceManagerConnection: '$(azureServiceConnection)'
#         #     subscriptionId: '$(devSubscriptionId)'
#         #     action: 'Create Or Update Resource Group'
#         #     resourceGroupName: '$(devResourceGroup)'
#         #     location: 'East US'   # CHANGE_ME if needed
#         #     templateLocation: 'Linked artifact'
#         #     csmFile: '$(Pipeline.Workspace)/$(artifactName)/$(armOutputFolder)/ARMTemplateForFactory.json'
#         #     csmParametersFile: '$(Pipeline.Workspace)/$(artifactName)/arm-parameters/dev.parameters.json'
#         #     deploymentMode: 'Incremental'
#         #     deploymentName: 'adf-dev-$(Build.BuildId)' 
            
         
